name: 'Build Fujinoki'

runs:
  using: 'composite'
  strategy:
    fail-fast: false
    matrix:
      # xtask/src/publish/mod.rs:64
      settings:
        - host: macos-latest
          target: "x86_64-apple-darwin"

        - host: macos-latest
          target: "aarch64-apple-darwin"
          setup: "apt-get install -y build-essential clang-5.0 lldb-5.0 llvm-5.0-dev libclang-5.0-dev"

        - host: ubuntu-latest
          target: "x86_64-unknown-linux-musl"
          setup: "apt-get install -y build-essential clang-5.0 lldb-5.0 llvm-5.0-dev libclang-5.0-dev"

        - host: windows-latest
          target: "x86_64-pc-windows-msvc"
  runs-on: ${{ matrix.settings.host }}
  timeout-minutes: 45
  steps:
    - name: Setup Container
      if: ${{ matrix.settings.container-setup }}
      run: ${{ matrix.settings.container-setup }}

    - uses: actions/checkout@v4

    - name: Install Rust
        uses: ./.github/actions/setup-rust
        with:
          targets: ${{ matrix.settings.target }}

    - name: Setup toolchain
      run: ${{ matrix.settings.setup }}
      if: ${{ matrix.settings.setup }}

    - name: Setup build
      shell: bash
      if: ${{ matrix.settings.setup }}
      run: ${{ matrix.settings.setup }}

    - name: Build
      run: ${{ matrix.settings.rust-build-env }} cargo build --profile release-fujinoki -p fujinoki-cli --target ${{ matrix.settings.target }}

    - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: fujinoki/${{ matrix.settings.target }}
          path: target/${{ matrix.settings.target }}/release-fujinoki/fujinoki-cli*
